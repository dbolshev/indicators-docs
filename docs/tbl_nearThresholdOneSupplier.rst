.. _tbl_nearThresholdOneSupplier:

============================
tbl_nearThresholdOneSupplier
============================

************************
Суть аналітичної таблиці
************************

Дана аналітична таблиця відображає, чи проводив Замовник протягом поточного року закупівлі у одного постачальника, що близькі до порогу 200К (general) та 1М (special) для товарів та послуг, або 1.5М(general) та 5М (special) для робіт.

*************************
Форма аналітичної таблиці
*************************

Аналітична таблиця містить наступну інформацію:

- Ідентифікатор замовника

- Ідентифікатор постачальника

Приклад того, як може виглядати аналітична таблиця:

========== ==============
Замовник   Постачальник
---------- --------------
Замовник 1 Постачальник 1
Замовник 2 Постачальник 2
Замовник 3 Постачальник 3
Замовник 4 Постачальник 1
Замовник 5 Постачальник 2
...        ...
========== ==============

******************************
Розрахунок аналітичної таблиці
******************************

Джерела даних для розрахунку
============================

Для розрахунку аналітичної таблиці вікористовуються наступні джерела даних:

- API модуля тендеринга електронної системи закупівель

- Визначення *товарів*, *послуг* чи *робіт* на основі транзакційної змінної :ref:`tv_subjectOfProcurement` та :ref:`порядку визначення категоріі закупівлі за кодом Єдиного закупівельного словника<gsw_formula>`.

- `API курсу валют Національного Банку України <https://bank.gov.ua/control/uk/publish/article?art_id=38441973#exchange>`_


Частота розрахунку
==================

Аналітична таблиця розраховується раз на добу.

Поля для розрахунку
===================

Для розрахунку використовуються наступні поля з API модуля тендеринга:

- ``data.procuringEntity.identifier.id``

- ``data.procuringEntity.identifier.scheme``

- ``data.awards.suppliers.identifier.scheme``

- ``data.awards.suppliers.identifier.id``

- ``data.procurementMethodType``

- ``data.status``

- ``data.tenderID``

- ``data.value``

- ``data.value.amount``

- ``data.value.currency``

- ``data.tenderPeriod.startDate``

Для розрахунку індикатора використовуються наступні транзакційні змінні:

- :ref:`tv_subjectOfProcurement`

Для розрахунку індикатора використовуються наступні поля з API курсу валют Національного Банку України:

- ``cc``

- ``rate``

- ``exchangedate``

Формула розрахунку
==================

1. Перед розрахунком аналітична таблиця очищується.

2. До уваги беруться усі процедури, у яких ``data.procurementMethodType`` мають бути ``belowThreshold``, ``reporting``. Процедури повинні бути завершені, тобто ``data.status = 'complete'``

3. Визначається дата створення тендера шляхом перетворення в дату 10 символів починаючи з 4-го з ``data.tenderID``. Нехай це буде "Дата оголошення"

4. До уваги беремо процедури, що оголошені у поточному році.

5. Для ``data.procurementMethodType = 'reporting'`` ``data.date`` має бути ранішою на 3 дні від дати розрахунку.

6. Визначаємо переможця процедури (конкатенація ``data.awards.suppliers.identifier.scheme`` та ``data.awards.suppliers.identifier.id``) з об'єктів, де ``data.awards.status = 'active'``.

7. Перевіряється валюта, в якій вказана очікувана вартість процедури відповідно до поля ``data.value.currency``

  7.а) Якщо очікувана вартість указана в гривнях, тобто ``data.value.currency = 'UAH'``, то вона залишається без змін.

  7.б) Якщо очікувана вартість указана не в гривнях, то вона переводиться у гривні відповідно до курсу даної валюти до гривні за допомогою API курсу валют на "Дату оголошення".

8. Якщо закупівлю проводить загальний замовник (general)

  8.а) Якщо очікувана вартість в гривнях перевищує 190000 (сто дев'яносто тисяч) і менше 200000 (двісті тисяч), та проводиться закупка *товарів* чи *послуг*, то  конкатенація ``data.procuringEntity.identifier.scheme`` та ``data.procuringEntity.identifier.id`` і конкатенація ``data.awards.suppliers.identifier.scheme`` та ``data.awards.suppliers.identifier.id`` заноситься в таблицю.
  
  8.б) Якщо очікувана вартість *в гривнях* перевищує 1350000 (один мільйон триста п'ятдесят тисяч) і менше 1500000 (один мільйон п'ятьсот тисяч), та проводиться закупка *робіт*, то  конкатенація ``data.procuringEntity.identifier.scheme`` та ``data.procuringEntity.identifier.id`` і конкатенація ``data.awards.suppliers.identifier.scheme`` та ``data.awards.suppliers.identifier.id`` заноситься в таблицю.
  
9. Якщо закупівлю проводить замовник, що здійснює діяльність в окремих сферах господарювання (``special``)

  9.а) Якщо очікувана вартість в гривнях перевищує 950000 (дев'ятьсот п'ятдесят тисяч) і менше 1000000 (один мільйон), та проводиться закупка *товарів* чи *послуг*, то  конкатенація ``data.procuringEntity.identifier.scheme`` та ``data.procuringEntity.identifier.id`` і конкатенація ``data.awards.suppliers.identifier.scheme`` та ``data.awards.suppliers.identifier.id`` заноситься в таблицю.
  
  9.б) Якщо очікувана вартість *в гривнях* перевищує 4500000 (чотири мільйона п'ятьсот тисяч) і менше 5000000 (п'ять мільйонів), та проводиться закупка *робіт*, то  конкатенація ``data.procuringEntity.identifier.scheme`` та ``data.procuringEntity.identifier.id`` і конкатенація ``data.awards.suppliers.identifier.scheme`` та ``data.awards.suppliers.identifier.id`` заноситься в таблицю.
  
